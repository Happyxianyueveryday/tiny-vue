## Vue双向绑定原理详解

Vue双向绑定包括从数据到视图的绑定和视图到数据的绑定，其中从视图到数据的绑定是较为简单的，当视图变化时，直接使用js中的事件监听即可完成。但是从数据到视图的绑定是难度较大的。如何实现当数据变化时视图随之更新，是本文档说明的重点。

本文档编写时的参考资料为: https://www.cnblogs.com/libin-1/p/6893712.html 。

在Vue中，从数据到视图的绑定是基于数据劫持和发布者-订阅者模式两种重要技术实现的。

### 1. 数据劫持
在js中，使用Object.defineProperty()方法实现数据劫持的，该方法的原型是：

```
/** 
 * Object.defineProperty: 精确添加或者修改对象的属性
 * param obj: 要在其上定义属性的对象
 * param prop: 要定义或修改的属性的名称
 * param descriptor: 将被定义或修改的属性描述符
 */
Object.defineProperty(obj, prop, descriptor)
```
在双向绑定的实现中，则只需要关注两个方法属性get和set，（不熟悉这两个方法属性的话可以参考https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty ） 一个示例用法如下，下述示例中劫持了Person的name属性，name属性值发生改变时指定set方法，获取name属性值时执行get方法：

```
<script>
    
    var Person={
        name: "",
    };

    Object.defineProperty(Person, "name", {   
        set: function(newname) {        // 给Person的name属性增加一个set属性，当name属性被改变时，触发执行set方法
            name=newname;
            console.log("setter已经被调用");
        },

        get: function() {               // 给Person的name属性增加一个get属性，当name属性被读取时，触发执行get方法
            console.log("getter已经被调用");
            return name;
        }
    });

</script>
```

### 2. 发布者-订阅者模式的应用
利用上述的数据劫持机制，结合发布者-订阅者模式，我们将整个过程的实现划分为三个组件Observer，Dep和Watcher：
+ Observer: Observer是发布者。Observer首先利用Object.defineProperty劫持所有响应式对象的所有属性，当某个属性的值改变时，在getter中将属性改变的消息通知给Dep。
+ Dep: 作为异步消息队列和转发器使用，Dep中存放所有的Watcher，并将从Observer收到的属性改变的消息转发给对应的Watcher。
+ Watcher: Watcher是订阅者。

三者间的结构图如下所示：

![avatar](https://images2015.cnblogs.com/blog/938664/201705/938664-20170522225458132-1434604303.png)

下面依次详细讲解这三个组件的具体实现原理。

#### 2.1 Observer的实现
Observer的任务包括：
+ 

对应的具体算法步骤可以简述为：

+ 属性劫持：对于给定的对象，遍历其中的每个属性，对于遍历访问到的每个属性，首先递归地劫持其所有子属性，然后劫持该属性本身。
+ 

